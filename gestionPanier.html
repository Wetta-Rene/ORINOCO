<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <link type="text/css" rel="stylesheet" href="css/styles.css" />
    <script src="js/scripts.js"></script>
    <title>ORINOCO - Panier</title>
</head>

<body>
    <script type="text/javascript">
        //////////////////////////////////// VARIABLES ET VERIFICATION POUR LE TRAITEMENT //////////////////////////////////////////////////////
        const urlComplete = window.location.href; //recupere l'url
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString); //recupere apres le ? de l'url
        const action = urlParams.get('actionPanier') //recupere catalogue
        const Id = urlParams.get('id') //recupere catalogue
        const option = urlParams.get('option') // recupere produit
        const quantite = urlParams.get('quantite') // recupere produit
        const catalogue = urlParams.get('catalogue') // recupere produit
        const retourUrl = urlParams.get('urlRetour') // recupere produit
        const name = urlParams.get('name') // recupere nom du produit
        const prixUnitaire = urlParams.get('prix') // recupere nom du produit
        const urlImage = urlParams.get('urlImage') // recupere nom du produit
        const description = urlParams.get('description') // recupere nom du produit


        //detection si tout est bon dans la transmission pas de modif utilisateur...
        var verifChaineUrlNonVide = "";
        if (action === "") {
            verifChaineUrlNonVide = "1";
        }
        if (Id === "") {
            verifChaineUrlNonVide = "1";
        }
        if (option === "") {
            verifChaineUrlNonVide = "1";
        }
        if (quantite === "") {
            verifChaineUrlNonVide = "1";
        }
        if (catalogue === "") {
            verifChaineUrlNonVide = "1";
        }
        if (retourUrl === "") {
            verifChaineUrlNonVide = "1";
        }
        if (name === "") {
            verifChaineUrlNonVide = "1";
        }
        if (prixUnitaire === "") {
            verifChaineUrlNonVide = "1";
        }
        if (urlImage === "") {
            verifChaineUrlNonVide = "1";
        }
        if (description === "") {
            verifChaineUrlNonVide = "1";
        }
        if (verifChaineUrlNonVide > 0) {
            window.location.href = retourUrl;
        }

        //////////////////////////////////// END //////////////////////////////////////////////////////


        //////////////////////////////////// AUTRE //////////////////////////////////////////////////////   
        if (action == "ajout") {


            //création d'une class pour creer une ligne plus facilement:
            class ligneDuPanier {
                constructor(reference, nom, quantite, option, prixUnitaire, prixAjour, catalogue, urlImage, description) {
                    this.reference = Id;
                    this.nom = nom;
                    this.quantite = quantite;
                    this.option = option;
                    this.prixUnitaire = prixUnitaire;
                    this.prixAjour = prixAjour;
                    this.catalogue = catalogue;
                    this.urlImage = urlImage;
                    this.description = description
                }
            }

            var prixAjour = prixUnitaire * quantite; // on change le prix si plus que 1 dans le panier
            //tri du panier
            if (localStorage.getItem("panier") === "vide") { //si panier d'origine car initialisation à null on ecrit directement dans le panier
                const ligne = new ligneDuPanier(Id, name, quantite, option, prixUnitaire, prixAjour, catalogue, urlImage, description);
                var Panier = [];
                Panier.push(ligne); // mis dans un tableau pour panier
                localStorage.messagePanier = "Produit ajouté !";
                localStorage.setItem("panier", JSON.stringify(Panier));
                window.location.href = retourUrl; // on revient à la page du produit
            } else { // c'est pas la première fois
                // const ligne = new ligneDuPanier(Id, name, quantite, prixUnitaire, prixAjour, catalogue); // nouveau produit a mettre dans panier
                var data = JSON.parse(localStorage.getItem("panier"));

                var produitTrouve = false;
                for (let x in data) {
                    if (data[x].reference == Id) {

                        produitTrouve = true;

                        // Augmenter la quantité et le prix
                        data[x].quantite++;
                        data[x].prixAjour = data[x].quantite * data[x].prixUnitaire;
                    }
                }

                if (!produitTrouve) {
                    const ligne = new ligneDuPanier(Id, name, quantite, option, prixUnitaire, prixAjour, catalogue, urlImage, description);
                    data.push(ligne);
                }

                // Sauvegarde du panier mis à jour
                localStorage.messagePanier = "Produit ajouté !";
                localStorage.setItem("panier", JSON.stringify(data));
                window.location.href = retourUrl; // on revient à la page du produit    

                // END

            } //fin du else panier non vide




        }

        //////////////////////////////////// END //////////////////////////////////////////////////////


        //////////////////////////////////// GESTION ARTICLES DANS LE PANIER //////////////////////////////////////////////////////
        if (action == "modificationPlus") { // modification quantite panier en plus
            var data = JSON.parse(localStorage.getItem("panier")); // on recupere le panier en local 
            var produitTrouve = false;
            for (let x in data) {
                if (data[x].reference == Id) {
                    produitTrouve = true;

                    // Augmenter la quantité et le prix
                    data[x].quantite++;
                    data[x].prixAjour = data[x].quantite * data[x].prixUnitaire;
                }
            }
            localStorage.messagePanier = "Quantité mise à jour !";
            // Sauvegarde du panier mis à jour
            localStorage.setItem("panier", JSON.stringify(data));
            window.location.href = "panier.html"; // on revient à la page du produit  */    
        } // fin de modificationPlus                  
        if (action == "modificationMoins") { // modification quantite panier en moins
            var data = JSON.parse(localStorage.getItem("panier")); // on recupere le panier en local 
            var produitTrouve = false;
            for (let x in data) {
                if (data[x].reference == Id) {
                    produitTrouve = true;

                    // Augmenter la quantité et le prix
                    data[x].quantite--;
                    data[x].prixAjour = data[x].quantite * data[x].prixUnitaire;
                }
            }
            localStorage.messagePanier = "Quantité mise à jour !";
            // Sauvegarde du panier mis à jour
            localStorage.setItem("panier", JSON.stringify(data));
            window.location.href = "panier.html"; // on revient à la page du produit  */    
        }


        //////////////////////////////////// END //////////////////////////////////////////////////////


        //////////////////////////////////// COMMANDE //////////////////////////////////////////////////////

        if (action == "eCommande") {

            const prenom = urlParams.get('prenom') //recupere catalogue
            const nom = urlParams.get('nom') //recupere catalogue 
            const mail = urlParams.get('mail') //recupere catalogue
            const numero = urlParams.get('numero') //recupere catalogue
            const ville = urlParams.get('ville') //recupere catalogue  
            const adresse = urlParams.get('adresse') //recupere catalogue  
            const codePostal = urlParams.get('codePostal') //recupere catalogue

            class formatUtilisateur {
                constructor(nom, prenom, adresse, ville, mail) {
                    this.firstname = prenom;
                    this.lastname = nom;
                    this.address = adresse;
                    this.city = ville;
                    this.email = mail;
                }
            }


            const utilisateur = new formatUtilisateur(prenom, nom, adresse, ville, mail);



            var produitsLocal = JSON.parse(localStorage.getItem("panier")); // on recupere le panier

            var commande = []; //on initie la commande

            for (var x = 0; x < produitsLocal.length; x++) {
                var ligneProduit = produitsLocal[x];
                commande.push(ligneProduit.reference);
            }

            var products = [];
            products.push(utilisateur);
            products.push(commande)
            console.log(JSON.stringify(products))

            var request = new XMLHttpRequest();
            request.open("POST", "http://localhost:3000/api/teddies/order");
            request.setRequestHeader("Content-Type", "application/json");
            request.send(JSON.stringify(products));

        }
        //////////////////////////////////// END //////////////////////////////////////////////////////


        //////////////////////////////////// AUTRE //////////////////////////////////////////////////////
    </script>